<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitácora Fiat Siena KBN73A</title>
    <!-- Cargando librerías externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        .ai-gradient { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); }
        .card-shadow { box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05); }
        input:focus { outline: none; border-color: #3b82f6; ring: 2px #3b82f6; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20">

    <div id="app" class="max-w-6xl mx-auto px-4 py-8">
        <!-- Encabezado con Identidad del Carro -->
        <header class="flex flex-col md:flex-row md:items-center justify-between mb-10 gap-4">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 p-3 rounded-2xl text-white shadow-lg shadow-blue-200">
                    <i data-lucide="car" class="w-8 h-8"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-black text-slate-900 tracking-tight">Mi Fiat Siena ELX</h1>
                    <p class="text-slate-500 font-semibold">Placa: <span class="text-blue-600 uppercase">KBN73A</span></p>
                </div>
            </div>
            <div id="auth-status" class="text-[10px] font-black uppercase tracking-widest px-4 py-2 rounded-full bg-white border border-slate-200 shadow-sm text-slate-400">
                Sincronizando Nube...
            </div>
        </header>

        <!-- Asistente de IA y Herramientas -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
            <div class="ai-gradient p-1 rounded-[2rem] shadow-2xl shadow-indigo-100 group transition-all">
                <div class="bg-white rounded-[1.8rem] p-7 h-full flex flex-col justify-between">
                    <div>
                        <div class="flex items-center gap-2 mb-4">
                            <i data-lucide="sparkles" class="text-indigo-500 w-5 h-5 animate-pulse"></i>
                            <h3 class="font-bold text-slate-800 text-xl">Consultar a Gemini IA ✨</h3>
                        </div>
                        <p class="text-sm text-slate-500 mb-6 leading-relaxed">¿Ruidos extraños? ¿Dudas sobre el motor 1.3 16V? Tu asistente experto está listo.</p>
                    </div>
                    <button id="btn-ai-assist" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black text-sm hover:bg-indigo-700 transition-all shadow-lg flex items-center justify-center gap-2">
                        Hablar con el Mecánico IA
                    </button>
                </div>
            </div>

            <div class="bg-white p-8 rounded-[2rem] border border-slate-200 card-shadow flex flex-col justify-between">
                <div>
                    <h3 class="font-bold text-slate-800 text-xl mb-2">Exportar Historial</h3>
                    <p class="text-sm text-slate-500">Genera un archivo compatible con Excel (CSV) para guardar en tu PC.</p>
                </div>
                <button id="export-csv" class="w-full py-4 border-2 border-slate-900 text-slate-900 rounded-2xl font-black text-sm hover:bg-slate-900 hover:text-white transition-all flex items-center justify-center gap-2 mt-6">
                    <i data-lucide="download" class="w-4 h-4"></i> Descargar Excel (.csv)
                </button>
            </div>
        </section>

        <!-- Métricas Principales -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <div class="bg-slate-900 rounded-[2rem] p-8 text-white md:col-span-2 flex flex-col justify-between shadow-2xl shadow-slate-200">
                <div>
                    <p class="text-slate-400 text-xs font-black uppercase tracking-[0.2em] mb-2">Inversión en Mantenimiento</p>
                    <div class="text-6xl font-black tracking-tighter" id="total-global">$ 0.00</div>
                </div>
                <div class="flex gap-8 mt-8">
                    <div>
                        <p class="text-slate-500 text-[10px] font-bold uppercase">Servicios</p>
                        <p id="service-count" class="text-xl font-bold">0</p>
                    </div>
                    <div>
                        <p class="text-slate-500 text-[10px] font-bold uppercase">Último Km</p>
                        <p id="last-km" class="text-xl font-bold text-blue-400">---</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-8 rounded-[2rem] border border-slate-200 card-shadow space-y-4">
                <h4 class="font-bold text-slate-800 border-b pb-2">Ficha Técnica</h4>
                <div class="space-y-3">
                    <div class="text-xs">
                        <span class="text-slate-400 block font-bold uppercase text-[9px]">Motor</span>
                        <span class="font-bold">1.3 16V Fire</span>
                    </div>
                    <div class="text-xs">
                        <span class="text-slate-400 block font-bold uppercase text-[9px]">VIN</span>
                        <span class="font-mono text-slate-500 break-all">9BD17218263219159</span>
                    </div>
                    <div class="text-xs">
                        <span class="text-slate-400 block font-bold uppercase text-[9px]">Líquidos</span>
                        <input id="v-frenos" type="text" placeholder="DOT 4" class="w-full bg-slate-50 border-none p-2 rounded mt-1 font-bold">
                    </div>
                </div>
                <button id="save-vehicle" class="w-full py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg text-xs font-bold transition-all">Guardar Datos</button>
            </div>
        </div>

        <!-- Tabla de Servicios -->
        <section class="bg-white rounded-[2rem] border border-slate-200 card-shadow overflow-hidden">
            <div class="p-8 border-b border-slate-100 flex justify-between items-center">
                <h2 class="text-xl font-black text-slate-800 flex items-center gap-3">
                    <i data-lucide="list-checks" class="text-blue-600"></i> Registros Sincronizados
                </h2>
                <button id="add-service" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-2xl font-black text-sm shadow-lg shadow-blue-100 transition-all active:scale-95">
                    Nuevo Registro
                </button>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50/50 text-slate-400 text-[10px] uppercase font-black tracking-widest">
                        <tr>
                            <th class="px-8 py-5">Fecha</th>
                            <th class="px-8 py-5">Kilometraje</th>
                            <th class="px-8 py-5">Servicio Realizado</th>
                            <th class="px-8 py-5 text-right">Costo Total</th>
                            <th class="px-8 py-5 text-center">⚙️</th>
                        </tr>
                    </thead>
                    <tbody id="services-body" class="divide-y divide-slate-100 text-sm">
                        <tr id="empty-state">
                            <td colspan="5" class="px-8 py-20 text-center text-slate-300 italic font-medium">
                                No hay registros guardados. Haz clic en "Nuevo Registro".
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- Modal Formulario -->
    <div id="modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-md hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-md overflow-hidden animate-in zoom-in duration-200">
            <div class="p-8 border-b border-slate-100 flex justify-between items-center">
                <h3 id="modal-title" class="text-2xl font-black text-slate-800">Registrar</h3>
                <button onclick="closeModal()" class="p-2 hover:bg-slate-100 rounded-full"><i data-lucide="x"></i></button>
            </div>
            <form id="service-form" class="p-8 space-y-4">
                <input type="hidden" id="service-id">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Fecha</label>
                        <input type="date" id="s-fecha" required class="w-full border-2 border-slate-50 bg-slate-50 rounded-xl p-3 text-sm focus:bg-white focus:border-blue-500 transition-all font-bold">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Km Actual</label>
                        <input type="number" id="s-km" required class="w-full border-2 border-slate-50 bg-slate-50 rounded-xl p-3 text-sm focus:bg-white focus:border-blue-500 transition-all font-bold" placeholder="0">
                    </div>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">¿Qué se reparó?</label>
                    <input type="text" id="s-detalle" required class="w-full border-2 border-slate-50 bg-slate-50 rounded-xl p-3 text-sm focus:bg-white focus:border-blue-500 transition-all" placeholder="Ej: Cambio de frenos">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Taller / Mecánico</label>
                    <input type="text" id="s-taller" class="w-full border-2 border-slate-50 bg-slate-50 rounded-xl p-3 text-sm focus:bg-white focus:border-blue-500 transition-all" placeholder="Nombre">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Repuestos $</label>
                        <input type="number" step="0.01" id="s-repuestos" class="w-full border-2 border-slate-50 bg-slate-50 rounded-xl p-3 text-sm font-bold" value="0">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Mano Obra $</label>
                        <input type="number" step="0.01" id="s-mano-obra" class="w-full border-2 border-slate-50 bg-slate-50 rounded-xl p-3 text-sm font-bold" value="0">
                    </div>
                </div>
                <button type="submit" class="w-full bg-slate-900 text-white font-black py-4 rounded-2xl hover:bg-slate-800 transition-all shadow-xl shadow-slate-200 mt-4">Guardar Registro</button>
            </form>
        </div>
    </div>

    <!-- Modal AI -->
    <div id="ai-modal" class="fixed inset-0 bg-indigo-950/40 backdrop-blur-md hidden items-center justify-center p-4 z-[60]">
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col h-[85vh] animate-in slide-in-from-bottom duration-300">
            <div class="ai-gradient p-8 text-white flex justify-between items-center">
                <h3 class="text-2xl font-black flex items-center gap-3"><i data-lucide="sparkles"></i> Asistente de IA</h3>
                <button onclick="closeAIModal()" class="hover:bg-white/20 p-2 rounded-full transition-colors"><i data-lucide="x"></i></button>
            </div>
            <div id="ai-chat" class="flex-1 overflow-y-auto p-8 space-y-6 text-sm bg-white">
                <div class="bg-indigo-50 p-6 rounded-[2rem] border border-indigo-100 text-indigo-900 leading-relaxed font-medium">
                    Hola. Soy Gemini, tu experto en el motor Fire 1.3 16V. ¿Tienes algún síntoma nuevo o quieres revisar tu plan de mantenimiento?
                </div>
            </div>
            <div class="p-6 bg-slate-50 border-t flex gap-3">
                <input type="text" id="ai-input" class="flex-1 border-0 bg-white rounded-2xl px-6 py-4 text-sm shadow-inner focus:ring-2 focus:ring-indigo-500 font-medium" placeholder="Describe ruidos o haz una pregunta...">
                <button id="ai-send" class="bg-indigo-600 text-white px-8 py-4 rounded-2xl font-black hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100">Consultar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG
        const apiKey = ""; // Runtime provisioned
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'siena-final-app-2024';

        let user = null;
        let globalData = [];

        // AUTH
        (async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
            else await signInAnonymously(auth);
        })();

        onAuthStateChanged(auth, u => {
            user = u;
            if (u) {
                document.getElementById('auth-status').innerText = "✓ Sincronizado";
                document.getElementById('auth-status').className = "text-[10px] font-black uppercase tracking-widest px-4 py-2 rounded-full bg-green-50 text-green-600 border border-green-200 shadow-sm";
                loadVehicle();
                subscribe();
            }
        });

        const vRef = () => doc(db, 'artifacts', appId, 'public', 'data', 'vehicle_config', 'details');
        const sRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'services');

        async function loadVehicle() {
            const snap = await getDoc(vRef());
            if (snap.exists()) {
                const d = snap.data();
                document.getElementById('v-frenos').value = d.frenos || '';
            }
        }

        document.getElementById('save-vehicle').onclick = async () => {
            await setDoc(vRef(), { frenos: document.getElementById('v-frenos').value, updated: new Date() });
            toast("Ficha técnica guardada");
        };

        function subscribe() {
            onSnapshot(query(sRef()), snap => {
                const data = [];
                snap.forEach(d => data.push({ id: d.id, ...d.data() }));
                data.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                globalData = data;
                render(data);
                stats(data);
            });
        }

        function render(items) {
            const b = document.getElementById('services-body');
            if (items.length === 0) {
                b.innerHTML = '<tr><td colspan="5" class="px-8 py-20 text-center text-slate-300 italic">No hay registros guardados.</td></tr>';
                return;
            }
            b.innerHTML = items.map(i => `
                <tr class="hover:bg-slate-50 transition-colors group animate-in fade-in duration-300">
                    <td class="px-8 py-6 font-bold text-slate-400 text-xs">${i.fecha}</td>
                    <td class="px-8 py-6 font-mono font-black text-slate-600">${parseInt(i.km || 0).toLocaleString()} km</td>
                    <td class="px-8 py-6 font-bold text-slate-800">${i.detalle}</td>
                    <td class="px-8 py-6 text-right font-black text-slate-900">$ ${((i.repuestos||0) + (i.manoObra||0)).toFixed(2)}</td>
                    <td class="px-8 py-6 text-center">
                        <div class="flex justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="editItem('${i.id}')" class="p-2 text-blue-600 hover:bg-blue-100 rounded-xl"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                            <button onclick="deleteItem('${i.id}')" class="p-2 text-red-600 hover:bg-red-100 rounded-xl"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        function stats(items) {
            const total = items.reduce((a, b) => a + (parseFloat(b.repuestos) || 0) + (parseFloat(b.manoObra) || 0), 0);
            const km = items.length > 0 ? Math.max(...items.map(i => parseInt(i.km) || 0)) : 0;
            document.getElementById('total-global').innerText = `$ ${total.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('service-count').innerText = items.length;
            document.getElementById('last-km').innerText = km ? `${km.toLocaleString()} km` : '---';
        }

        document.getElementById('export-csv').onclick = () => {
            if (globalData.length === 0) return toast("No hay datos");
            const h = "Fecha,Km,Detalle,Taller,Repuestos,ManoObra,Total\n";
            const c = globalData.map(i => `${i.fecha},${i.km},"${i.detalle}","${i.taller}",${i.repuestos},${i.manoObra},${(i.repuestos+i.manoObra)}`).join('\n');
            const blob = new Blob([h + c], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "mi_siena_mantenimiento.csv";
            link.click();
        };

        const aiModal = document.getElementById('ai-modal');
        document.getElementById('btn-ai-assist').onclick = () => aiModal.classList.replace('hidden', 'flex');
        window.closeAIModal = () => aiModal.classList.replace('flex', 'hidden');

        async function callGemini(p) {
            const sys = "Experto mecánico en Fiat Siena 2006 1.3 16V Fire. Sé profesional y directo.";
            try {
                const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{parts: [{text: p}]}], systemInstruction: {parts: [{text: sys}]} })
                });
                const d = await r.json();
                return d.candidates[0].content.parts[0].text;
            } catch(e) { return "Error al conectar con la IA."; }
        }

        document.getElementById('ai-send').onclick = async () => {
            const input = document.getElementById('ai-input');
            if(!input.value) return;
            const chat = document.getElementById('ai-chat');
            chat.innerHTML += `<div class="bg-indigo-600 text-white p-5 rounded-[2rem] ml-12 self-end font-bold shadow-md">${input.value}</div>`;
            const query = input.value; input.value = "";
            const load = document.createElement('div'); load.className = "text-indigo-400 font-bold text-xs ml-4 animate-pulse"; load.innerText = "Gemini analizando..."; chat.appendChild(load);
            const hist = globalData.slice(0,5).map(i => `${i.fecha}: ${i.detalle}`).join(', ');
            const res = await callGemini(`Vehículo: Siena 1.3 16V. Historial: ${hist}. Consulta: ${query}`);
            load.remove();
            chat.innerHTML += `<div class="bg-slate-50 p-6 rounded-[2rem] mr-12 text-slate-800 leading-relaxed border border-slate-200 shadow-sm">${res}</div>`;
            chat.scrollTop = chat.scrollHeight;
        };

        const modal = document.getElementById('modal');
        document.getElementById('add-service').onclick = () => {
            document.getElementById('modal-title').innerText = "Nuevo Registro";
            document.getElementById('service-form').reset();
            document.getElementById('service-id').value = "";
            modal.classList.replace('hidden', 'flex');
        };
        window.closeModal = () => modal.classList.replace('flex', 'hidden');

        document.getElementById('service-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('service-id').value;
            const data = {
                fecha: document.getElementById('s-fecha').value,
                km: parseInt(document.getElementById('s-km').value),
                detalle: document.getElementById('s-detalle').value,
                taller: document.getElementById('s-taller').value,
                repuestos: parseFloat(document.getElementById('s-repuestos').value) || 0,
                manoObra: parseFloat(document.getElementById('s-mano-obra').value) || 0,
                updated: new Date()
            };
            if(id) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'services', id), data);
            else await addDoc(sRef(), data);
            closeModal();
            toast("Registro sincronizado");
        };

        window.deleteItem = async id => { if(confirm("¿Eliminar?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'services', id)); };
        window.editItem = id => {
            const i = globalData.find(x => x.id === id);
            document.getElementById('modal-title').innerText = "Editar Registro";
            document.getElementById('service-id').value = id;
            document.getElementById('s-fecha').value = i.fecha;
            document.getElementById('s-km').value = i.km;
            document.getElementById('s-detalle').value = i.detalle;
            document.getElementById('s-taller').value = i.taller || "";
            document.getElementById('s-repuestos').value = i.repuestos;
            document.getElementById('s-mano-obra').value = i.manoObra;
            modal.classList.replace('hidden', 'flex');
        };

        function toast(m) {
            const t = document.createElement('div');
            t.className = "fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-8 py-4 rounded-3xl text-sm font-black shadow-2xl z-[100] animate-in slide-in-from-bottom duration-300";
            t.innerText = m;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        lucide.createIcons();
    </script>
</body>
</html>